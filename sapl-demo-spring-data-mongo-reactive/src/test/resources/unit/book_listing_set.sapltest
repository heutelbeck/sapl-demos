/*
 * Tests for the book listing policy set (MongoDB Reactive)
 *
 * Library staff and their assigned sections:
 *   boss - Head librarian (all sections: [1,2,3,4,5])
 *   zoe  - Children & SciFi specialist ([1,2])
 *   bob  - Science & Mystery sections ([3,4])
 *   ann  - Classics curator ([5])
 *   pat  - New intern (empty scope [] - access denied)
 *
 * Note: This policy uses action == "findAll" (literal string) and
 * mongoQueryManipulation obligation format for MongoDB query rewriting.
 */

requirement "Policy Set should deny access when dataScope is null, undefined, or empty" {

    given
        - document "book_listing_set"

    scenario "deny when dataScope is null"
        when
            { "principal": { "dataScope": null } }
        attempts "findAll"
        on "books"
        expect deny;

    scenario "deny when dataScope is empty array"
        when
            { "principal": { "dataScope": [] } }
        attempts "findAll"
        on "books"
        expect deny;
}

requirement "Policy Set should permit access with MongoDB query manipulation obligation" {

    given
        - document "book_listing_set"

    scenario "permit boss with all sections"
        when
            { "principal": { "dataScope": [1, 2, 3, 4, 5] } }
        attempts "findAll"
        on "books"
        expect decision is permit, with obligation containing key "type" with value matching text "mongoQueryManipulation";

    scenario "permit zoe with sections 1 and 2"
        when
            { "principal": { "dataScope": [1, 2] } }
        attempts "findAll"
        on "books"
        expect decision is permit, with obligation containing key "type" with value matching text "mongoQueryManipulation";

    scenario "permit bob with sections 3 and 4"
        when
            { "principal": { "dataScope": [3, 4] } }
        attempts "findAll"
        on "books"
        expect decision is permit, with obligation containing key "type" with value matching text "mongoQueryManipulation";

    scenario "permit ann with section 5 only"
        when
            { "principal": { "dataScope": [5] } }
        attempts "findAll"
        on "books"
        expect decision is permit, with obligation containing key "type" with value matching text "mongoQueryManipulation";

    scenario "obligation has conditions array"
        when
            { "principal": { "dataScope": [1, 2] } }
        attempts "findAll"
        on "books"
        expect decision is permit, with obligation containing key "conditions";
}

requirement "Policy Set should not apply to other actions" {

    given
        - document "book_listing_set"

    scenario "not-applicable for delete action"
        when
            { "principal": { "dataScope": [1, 2, 3] } }
        attempts "delete"
        on "books"
        expect not-applicable;

    scenario "not-applicable for save action"
        when
            { "principal": { "dataScope": [1, 2, 3] } }
        attempts "save"
        on "books"
        expect not-applicable;

    scenario "not-applicable for java action object format"
        when
            { "principal": { "dataScope": [1, 2, 3] } }
        attempts
            { "java": { "name": "findAll" } }
        on "books"
        expect not-applicable;
}
