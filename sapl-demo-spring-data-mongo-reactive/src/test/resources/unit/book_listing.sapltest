/*
 * Tests for book_listing.sapl policy
 *
 * This tests the MongoDB query manipulation policy that filters books based on user dataScope.
 *
 * Policy structure:
 * - Policy set target: action == "findAll"
 * - Policy 1 "deny if scope null": DENY when dataScope in [null, undefined]
 * - Policy 2 "empty scope means no limit": PERMIT when dataScope == []
 * - Policy 3 "enforce filtering": PERMIT with mongoQueryManipulation obligation
 */

requirement "Book listing policy should enforce data scope filtering" {

    given
        - document "book_listing"

    // Test 1: Policy set target NOT matching - different action
    scenario "different action does not trigger policy set"
        when { "principal": { "dataScope": [1, 2, 3] } }
        attempts "findById"
        on "book"
        expect not-applicable;

    // Test 2: Policy 1 - DENY when dataScope is null
    scenario "null dataScope results in deny"
        when { "principal": { "dataScope": null } }
        attempts "findAll"
        on "book"
        expect deny;

    // Test 3: Policy 1 - DENY when dataScope is undefined (missing)
    scenario "undefined dataScope results in deny"
        when { "principal": {} }
        attempts "findAll"
        on "book"
        expect deny;

    // Test 4: Policy 2 - PERMIT without obligation when dataScope is empty array
    scenario "empty dataScope means full access without filtering"
        when { "principal": { "dataScope": [] } }
        attempts "findAll"
        on "book"
        expect permit;

    // Test 5: Policy 3 - PERMIT with obligation when dataScope has values
    scenario "non-empty dataScope triggers filtering obligation"
        when { "principal": { "dataScope": [1, 2, 3] } }
        attempts "findAll"
        on "book"
        expect decision is permit, with obligation containing key "type" with value matching text "mongoQueryManipulation";

    // Test 6: Verify obligation contains conditions with category filter
    scenario "filtering obligation contains category conditions"
        when { "principal": { "dataScope": [1, 2] } }
        attempts "findAll"
        on "book"
        expect decision is permit, with obligation matching object where {
            "type" is text "mongoQueryManipulation" and "conditions" is array
        };

    // Test 7: Single category scope
    scenario "single category in dataScope works correctly"
        when { "principal": { "dataScope": [5] } }
        attempts "findAll"
        on "book"
        expect decision is permit, with obligation;
}
