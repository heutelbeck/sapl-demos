/*
 * Tests for the book listing policy set (R2DBC)
 *
 * Library staff and their assigned sections:
 *   boss - Head librarian (all sections: [1,2,3,4,5])
 *   zoe  - Children & SciFi specialist ([1,2])
 *   bob  - Science & Mystery sections ([3,4])
 *   ann  - Classics curator ([5])
 *   pat  - New intern (empty scope [] - access denied)
 */

requirement "Policy Set should deny access when dataScope is null, undefined, or empty" {

    given
        - document "book_listing_set"

    scenario "deny when dataScope is undefined"
        when
            { "principal": { } }
        attempts
            "findAll"
        on "books"
        expect deny;

    scenario "deny when dataScope is null"
        when
            { "principal": { "dataScope": null } }
        attempts
            "findAll"
        on "books"
        expect deny;

    scenario "deny when dataScope is empty array"
        when
            { "principal": { "dataScope": [] } }
        attempts
            "findAll"
        on "books"
        expect deny;
}

requirement "Policy Set should permit access with r2dbcQueryManipulation obligation when dataScope has values" {

    given
        - document "book_listing_set"

    scenario "permit boss with all sections and r2dbc query manipulation"
        when
            { "principal": { "dataScope": [1, 2, 3, 4, 5] } }
        attempts
            "findAll"
        on "books"
        expect decision is permit, with obligation equals {
            "type": "r2dbcQueryManipulation",
            "conditions": [ "category IN (1, 2, 3, 4, 5)" ]
        };

    scenario "permit zoe with sections 1 and 2"
        when
            { "principal": { "dataScope": [1, 2] } }
        attempts
            "findAll"
        on "books"
        expect decision is permit, with obligation equals {
            "type": "r2dbcQueryManipulation",
            "conditions": [ "category IN (1, 2)" ]
        };

    scenario "permit bob with sections 3 and 4"
        when
            { "principal": { "dataScope": [3, 4] } }
        attempts
            "findAll"
        on "books"
        expect decision is permit, with obligation equals {
            "type": "r2dbcQueryManipulation",
            "conditions": [ "category IN (3, 4)" ]
        };

    scenario "permit ann with section 5 only"
        when
            { "principal": { "dataScope": [5] } }
        attempts
            "findAll"
        on "books"
        expect decision is permit, with obligation equals {
            "type": "r2dbcQueryManipulation",
            "conditions": [ "category IN (5)" ]
        };
}

requirement "Policy Set should not apply to other actions" {

    given
        - document "book_listing_set"

    scenario "not-applicable for delete action"
        when
            { "principal": { "dataScope": [1, 2, 3] } }
        attempts
            "delete"
        on "books"
        expect not-applicable;

    scenario "not-applicable for save action"
        when
            { "principal": { "dataScope": [1, 2, 3] } }
        attempts
            "save"
        on "books"
        expect not-applicable;
}
