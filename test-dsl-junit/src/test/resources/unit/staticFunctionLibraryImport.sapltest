/*
 * Function Library Demo
 *
 * This file demonstrates working with function libraries in SAPL tests:
 * - Using function libraries in policies (like FilterFunctionLibrary)
 * - Mocking function library methods for controlled testing
 * - Testing obligations with transformed resources
 * - Complex matcher syntax for obligations and resources
 *
 * Function libraries are registered with the PDP/test fixture.
 * Tests can mock specific function calls for controlled behavior.
 */

requirement "FilterFunctionLibrary blacken is applied" {

    given
        // This policy uses FilterFunctionLibrary to blacken parts of the resource
        // and creates obligations for audit logging
        - document "policyWithObligationAndResource"

    scenario "admin can access with blackened resource"
        // Complex subject with name and authority
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        // Action with nested structure
        attempts
            { "java": { "name": "findById" } }
        // Resource to be transformed
        on
            { "id": 56, "diagnosisText": "diagnosisText", "icd11Code": "icd11Code" }
        // Expect permit with specific obligations and transformed resource
        expect permit
            with obligations {
                "type": "logAccess",
                "message": "willi has accessed patient data (id=56) as an administrator."
            }
            with resource {
                "diagnosisText": "█████████████",
                "icd11Code": "ic███████",
                "id": 56
            };

    scenario "admin access with matcher-based obligation verification"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "diagnosisText", "icd11Code": "icd11Code" }
        // Use matchers when exact values might vary (timestamps, generated IDs, etc.)
        expect decision is permit,
            // Obligation matcher: verify structure without exact values
            with obligation matching object where {
                "type" is text "logAccess"
                and
                // Match partial message containing key information
                "message" is text containing stream "willi", "patient data", "administrator" in order
            },
            // Resource matcher with exact equality
            with resource equals {
                "diagnosisText": "█████████████",
                "icd11Code": "ic███████",
                "id": 56
            };

    scenario "non-admin is denied"
        when
            { "name": "willi", "authority": "ROLE_USER" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "diagnosisText", "icd11Code": "icd11Code" }
        // Policy is permit-only for ROLE_ADMIN, so ROLE_USER gets not-applicable
        expect not-applicable;
}

requirement "Function mocking for controlled testing" {

    given
        - document "policyWithObligationAndResource"

    scenario "mock blacken function to return custom value"
        given
            // Mock the filter.blacken function to return a controlled value
            - function filter.blacken(any, any, any, any) maps to "REDACTED"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "secret", "icd11Code": "ABC" }
        // With mocked blacken, resource contains "REDACTED" instead of unicode blocks
        expect decision is permit, with obligation;

    scenario "mock blacken with specific input matching"
        given
            // Mock filter.blacken with specific parameter matchers
            - function filter.blacken(matching text "secret") maps to "[HIDDEN]"
            - function filter.blacken(matching text "ABC") maps to "***"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "secret", "icd11Code": "ABC" }
        expect decision is permit;

    scenario "verify blacken was called"
        given
            - function filter.blacken(any, any, any, any) maps to "CENSORED"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "text1", "icd11Code": "text2" }
        expect decision is permit, with obligation
        verify
            // Verify blacken was called twice (once for each field)
            - function filter.blacken(any, any, any, any) is called 2 times;
}

requirement "Matcher syntax demonstration" {

    given
        - document "policyWithObligationAndResource"

    scenario "obligation with text matchers"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 99, "diagnosisText": "test", "icd11Code": "code" }
        expect decision is permit,
            with obligation matching object where {
                // Text exact match
                "type" is text "logAccess"
                and
                // Text starts with
                "message" is text starting with "willi"
            };

    scenario "resource with number matcher"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 42, "diagnosisText": "test", "icd11Code": "code" }
        expect decision is permit,
            with resource matching object where {
                // Number must be present
                "id" is number 42
            };

    scenario "any decision matcher"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 1, "diagnosisText": "x", "icd11Code": "y" }
        // Just check some decision is returned
        expect decision any;
}
