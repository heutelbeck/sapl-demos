/*
 * Function Mocking Demo
 *
 * This file demonstrates how to mock functions in SAPL tests:
 * - Function mocking with exact value matchers
 * - Function mocking with 'any' matcher
 * - Function mocking with typed matchers (matching X)
 * - Function call verification in verify blocks
 * - Obligations and resource transformation testing
 */

requirement "Function mocking with simple function policy" {

    // Document at requirement level - all scenarios test this document
    given
        - document "policyWithSimpleFunction"

    // Scenario using policyWithSimpleFunction which calls time.dayOfWeek()
    scenario "mock dayOfWeek to return MONDAY"
        given
            // Mock the function with exact parameter match
            - function time.dayOfWeek("2021-02-08T16:16:33.616Z") maps to "MONDAY"
        when "user" attempts "read" on "resource"
        expect permit;

    scenario "mock dayOfWeek with any parameter"
        given
            // Mock the function to accept any parameter
            - function time.dayOfWeek(any) maps to "FRIDAY"
        when "user" attempts "read" on "resource"
        expect permit;

    scenario "mock dayOfWeek to return SUNDAY causes deny"
        given
            // SUNDAY is not in the allowed days
            - function time.dayOfWeek(any) maps to "SUNDAY"
        when "user" attempts "read" on "resource"
        expect not-applicable;

    scenario "mock dayOfWeek and verify call count"
        given
            - function time.dayOfWeek(any) maps to "WEDNESDAY"
        when "user" attempts "read" on "resource"
        expect permit
        verify
            - function time.dayOfWeek(any) is called once;

    scenario "mock dayOfWeek with matching text"
        given
            // Use matching syntax for parameter
            - function time.dayOfWeek(matching text) maps to "TUESDAY"
        when "user" attempts "read" on "resource"
        expect permit;
}

requirement "Function mocking with streaming policy" {

    // Document at requirement level
    given
        - document "policyStreaming"

    // policyStreaming uses time.secondOf(<time.now>) > 4
    scenario "mock secondOf to allow access"
        given
            // Mock the attribute and function
            - attribute "nowMock" <time.now> emits "2021-02-08T16:16:05.000Z"
            // Mock secondOf to return 5 (> 4, so permit)
            - function time.secondOf(any) maps to 5
        when "ROLE_DOCTOR" attempts "read" on "heartBeatData"
        expect permit
        verify
            - function time.secondOf(any) is called once;

    scenario "mock secondOf to deny access"
        given
            - attribute "nowMock" <time.now> emits "2021-02-08T16:16:01.000Z"
            // Mock secondOf to return 3 (<= 4, so deny)
            - function time.secondOf(any) maps to 3
        when "ROLE_DOCTOR" attempts "read" on "heartBeatData"
        expect not-applicable;

    scenario "verify function called multiple times with stream"
        given
            // Mock attribute to emit multiple values
            - attribute "nowMock" <time.now> emits "first"
            // Mock function (idempotent - same result for any call)
            - function time.secondOf(any) maps to 5
        when "ROLE_DOCTOR" attempts "read" on "heartBeatData"
        expect permit
        then
            - attribute "nowMock" emits "second"
        expect permit
        then
            - attribute "nowMock" emits "third"
        expect permit
        verify
            - function time.secondOf(any) is called 3 times;
}

requirement "Function mocking with filter library" {

    // Document at requirement level
    given
        - document "policyWithObligationAndResource"

    // policyWithObligationAndResource uses FilterFunctionLibrary
    scenario "admin with blacken filter creates obligations"
        given
            // Filter functions are available, mock filter.blacken (4 params: value, start, end, replacement) to return specific value
            - function filter.blacken(any, any, any, any) maps to "REDACTED"
        when
            { "name": "willi", "authority": "ROLE_ADMIN" }
        attempts
            { "java": { "name": "findById" } }
        on
            { "id": 56, "diagnosisText": "secret", "icd11Code": "ABC123" }
        // Expect permit with obligations
        expect decision is permit, with obligation;
}

requirement "Function mocking with multiple parameters" {

    // Document at requirement level
    given
        - document "policyWithSimpleFunction"

    scenario "mock function with multiple exact parameters"
        given
            // Hypothetical function with multiple params
            - function time.dayOfWeek("2021-02-08T16:16:33.616Z") maps to "MONDAY"
        when "user" attempts "read" on "resource"
        expect permit
        verify
            - function time.dayOfWeek("2021-02-08T16:16:33.616Z") is called once;

    scenario "mock function with mixed matchers"
        given
            // First param exact, would need 'any' for flexibility
            - function time.dayOfWeek(matching text "2021-02-08T16:16:33.616Z") maps to "THURSDAY"
        when "user" attempts "read" on "resource"
        expect permit;

    scenario "mock no-arg function does not match arity"
        given
            // Mock with no parameters - won't match policy's 1-arg call
            - function time.dayOfWeek() maps to "MONDAY"
            // Also mock the 1-arg version to show arity-specific mocking
            - function time.dayOfWeek(any) maps to "FRIDAY"
        when "user" attempts "read" on "resource"
        // 1-arg mock matches, returns FRIDAY, policy permits
        expect permit;

    scenario "mock function returning error"
        given
            // Function can return an error
            - function time.dayOfWeek(any) maps to error("time service unavailable")
        when "user" attempts "read" on "resource"
        expect indeterminate;
}

requirement "Function mocking with undefined values" {

    // Document at requirement level
    given
        - document "policyWithSimpleFunction"

    scenario "mock function returning undefined"
        given
            // Function can return undefined - causes condition to not match
            - function time.dayOfWeek(any) maps to undefined
        when "user" attempts "read" on "resource"
        // undefined values cause conditions to evaluate to false, making policy not applicable
        expect not-applicable;
}
